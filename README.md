# QZSS災害・危機管理通報受信システム

M5Stack Basicを使用してQZSS（準天頂衛星システム）からの災害・危機管理通報（DC Report/DCX）を受信・表示するシステムです。

## 概要

このシステムは、QZSS衛星からのL1S信号を受信し、災害情報をリアルタイムで表示します。災害通報が受信されていない間も、衛星の受信状況や信号強度を監視できます。受信した災害通報は自動的に保存され、過去の通報内容を確認できます。

### 開発経緯
このプロジェクトは、[@ksasao氏のQZSS DC Report/DCX受信に関する記事](https://x.com/ksasao/status/1951457364667932775?s=06)を参考に開発されました。元のコードベースは[スイッチサイエンスの記事](https://www.switch-science.com/blogs/magazine/gps-qzss-dc-report-dcx-receiving)と[サンプルコード](https://github.com/SWITCHSCIENCE/samplecodes/tree/master/GPS_shield_for_ESPr/espr_dev_qzss_drc_drx_decode)に基づいており、M5Stackでの画面表示機能を追加して改良されています。

### 主な機能
- **リアルタイム衛星監視**: QZSS衛星の受信状況をリアルタイムで表示
- **信号強度表示**: 各衛星の信号強度を視覚的に表示（色分け）
- **災害通報受信**: DC Report/DCXメッセージの自動受信・表示
- **日本語解析**: 受信したL1Sメッセージを日本語で解析・表示
- **通報保存機能**: 最大10件の災害通報を自動保存
- **履歴表示**: 保存された通報の一覧・詳細表示
- **多衛星システム対応**: GPS、Galileo、BeiDou、GLONASSも監視
- **日本語表示**: 日本語フォントによる分かりやすい表示

## 必要な機材

- **M5Stack Basic** (M5Stack Core)
- **M5Stack用GNSSモジュール 気圧/IMU/地磁気センサ付き（NEO-M9N/BMP280/BMI270/BMM150）** — スイッチサイエンス
- **GPSアンテナ** (U.FL/IPEXコネクタ対応)
- **USB Type-Cケーブル** (M5Stack用)

## 接続方法

### DIPスイッチ設定
画像に示されているDIPスイッチの設定：
- **TXスイッチ**: 1=ON, 2=OFF, 3=OFF, 4=OFF
- **RXスイッチ**: 1=ON, 2=OFF, 3=OFF, 4=OFF
- **PPSスイッチ**: 1=OFF（推奨）- シリアルモニターとディスプレイの両方が正常に動作

この設定により、シリアル通信がGPIO16（RX）とGPIO17（TX）に割り当てられます。

### 物理接続
GNSSモジュールはM5Stackの内部に直接接続されており、追加の配線は不要です。

| 機能 | GPIO | 説明 |
|------|------|------|
| RX   | GPIO16 | 受信ピン |
| TX   | GPIO17 | 送信ピン |
| 電源 | 3.3V | 内部供給 |
| GND  | GND | 内部接続 |

### アンテナ接続
1. **アンテナの準備**: U.FL/IPEXコネクタ対応のGPSアンテナを用意
2. **コネクタ接続**: M5Stack基板上のU.FL/IPEXコネクタにアンテナを接続
3. **固定**: アンテナが外れないよう適切に固定

## M5Stackの操作方法

### 基本操作

#### **ボタンA（左ボタン）**
- **機能**: 画面の手動更新 / 通常表示に戻る
- **使用場面**: 
  - 衛星情報の表示を最新状態に更新したい場合
  - 他の画面から通常表示に戻る場合
- **操作方法**: ボタンを1回押す

#### **ボタンB（中央ボタン）**
- **機能**: 保存済みDC通報一覧表示
- **使用場面**: 過去に受信した災害通報の一覧を確認したい場合
- **表示内容**: 
  - 保存された通報の一覧（最新5件）
  - 各通報の受信時刻、衛星ID、通報種類
- **操作方法**: ボタンを1回押す

#### **ボタンC（右ボタン）**
- **機能**: 最新通報の詳細表示
- **使用場面**: 最新の災害通報の詳細内容を確認したい場合
- **表示内容**: 
  - 最新通報の完全な詳細情報
  - 日本語で解析された通報内容
  - 全Wordデータ（16進数）
- **操作方法**: ボタンを1回押す

### 画面更新タイミング
- **自動更新**: 3秒間隔で衛星情報を自動更新
- **手動更新**: ボタンAを押すことで即座に画面更新
- **災害通報時**: 通報受信と同時に画面が切り替わり、3秒間保持

### 画面表示の説明

#### **通常監視画面**
```
QZSS L1S信号監視中
==================
QZSS衛星: 3機受信中
L1S受信可能: 2機
L1S受信中: 1機
最高信号強度: 25dB
------------------
QZSS詳細:
QZSS-01: ||||||||| 25dB [L1S受信中]
QZSS-02: |||||| 20dB [L1S受信可能]
QZSS-03: ||| 15dB [L1S弱い]
------------------
その他の衛星:
GPS: 8機 (最大48 dB)
Galileo: 4機 (最大45 dB)
BeiDou: 2機 (最大42 dB)
------------------
更新: 12:34:56
総衛星数: 17機
L1S信号: 受信済み (1機)
L1S受信: 5回 (最終: 30s前)
```

#### **災害通報受信時**
- **DC Report受信**: 画面が赤色に変わり、災害情報を日本語で表示
- **DCX受信**: 画面がオレンジ色に変わり、拡張災害情報を表示
- **表示内容**: 受信時刻、衛星ID、メッセージ長、日本語の通報内容

#### **保存済みDC通報一覧画面（ボタンB）**
```
=== 保存済みDC通報 ===
総通報数: 3件
==================
1. DC Report (QZSS-01)
   45s前
   災害通報
2. DCX (QZSS-02)
   120s前
   拡張災害通報
3. DC Report (QZSS-01)
   300s前
   災害通報
==================
ボタンA: 通常表示
ボタンC: 最新通報詳細
```

#### **最新通報詳細画面（ボタンC）**
```
=== DC通報詳細 ===
最新通報 #3
==================
タイプ: DC Report (Type 43)
衛星ID: QZSS-01
受信時刻: 45s前
メッセージ長: 8 words
Word Data:
Word[0]: C6804400
Word[1]: E0000000
Word[2]: 00000000
Word[3]: 00000000
Word[4]: 00000000
Word[5]: 00000000
Word[6]: 00000000
Word[7]: D4D4D754
==================
通報内容解析:
通報内容:
[日本語で解析された災害通報の詳細内容]
==================
ボタンA: 通常表示
ボタンB: 一覧表示
```

#### **エラー表示**
- **GNSSモジュール未検出**: 赤色画面でエラーメッセージ表示
- **衛星信号未受信**: 受信待機メッセージ表示
- **初期化中**: 起動時の初期化メッセージ表示

### 信号強度の見方

#### **バーグラフ表示（色分け）**
- `|`: 信号強度の単位（3dBごと）
- **赤色**: 弱い信号（0-15dB）
- **黄色**: 中程度の信号（15-30dB）
- **緑色**: 強い信号（30dB以上）
- 例: `|||||||||` = 25dB以上（緑色）

#### **L1S信号状態**
- **[L1S受信中]**: 実際にL1S信号を受信中（緑色）
- **[L1S受信可能]**: 信号強度が十分でL1S受信可能（水色）
- **[L1S弱い]**: 信号が弱くL1S受信が困難（黄色）
- **[L1S不可]**: 信号が弱すぎてL1S受信不可（赤色）

#### **信号強度の目安**
- **30dB以上**: 良好な受信状態、L1S受信可能
- **20-30dB**: 通常の受信状態、L1S受信可能
- **15-20dB**: 弱い信号、L1S受信が困難
- **15dB未満**: 受信困難、L1S受信不可

### トラブルシューティング

#### **QZSS衛星が受信されない場合**
1. **地理的要因の確認**
   - QZSS衛星は主にアジア太平洋地域で可視
   - 日本以外の地域では受信が困難な場合がある
2. **アンテナの向きを確認**
   - 屋外で空が見える場所に移動
   - 南向き（日本から見て）にアンテナを向ける
   - アンテナを水平に保つ
3. **DIPスイッチ設定を確認**
   - TXスイッチ: 1=ON, 2=OFF, 3=OFF, 4=OFF
   - RXスイッチ: 1=ON, 2=OFF, 3=OFF, 4=OFF
   - PPSスイッチ: 1=OFF（推奨）
4. **時間帯の確認**
   - 特定の時間帯ではQZSS衛星が見えない場合がある
5. **初期化を待つ**
   - 初回起動時は衛星捕捉に数分かかる場合があります

#### **L1S信号が受信されない場合**
1. **QZSS基本設定の確認**
   - シリアルモニターで「QZSS basic enabled successfully」を確認
2. **信号強度の確認**
   - 信号強度が15dB以上あることを確認
3. **アンテナの調整**
   - より強い信号を受信できるようアンテナの向きを調整

#### **画面が表示されない場合**
1. **電源を確認**
   - USBケーブルが正しく接続されているか確認
   - M5Stackの電源LEDが点灯しているか確認
2. **リセット**
   - M5Stackのリセットボタンを押す
   - 再起動後、初期化メッセージが表示されることを確認
3. **ファームウェア確認**
   - 正しいスケッチがアップロードされているか確認
   - Arduino IDEでシリアルモニターを開いてデバッグ情報を確認

## 技術仕様

### 使用機材詳細
- **GNSSモジュール**: u-blox NEO-M9N-00B-00
- **気圧センサ**: BMP280
- **IMUセンサ**: BMI270
- **地磁気センサ**: BMM150
- **アンテナコネクタ**: U.FL/IPEX

### 対応メッセージタイプ
- **MT 43**: DC Report（災害・危機管理通報）- 日本語解析対応
- **MT 44**: DCX message（災害・危機管理通報拡張）- 日本語解析対応
- **MT 47**: Monitoring Station Information
- **MT 48**: PRN Mask
- **MT 49**: Data Issue Number
- **MT 50**: DGPS Correction
- **MT 51**: Satellite Health
- **MT 63**: Null message

### 対応衛星システム
- **QZSS**: 準天頂衛星システム（メイン、L1S信号対応）
- **GPS**: 全地球測位システム
- **Galileo**: 欧州測位システム
- **BeiDou**: 中国測位システム
- **GLONASS**: ロシア測位システム

### 通信仕様
- **シリアル通信**: 9600bps（初期）、38400bps（自動切り替え）
- **通信プロトコル**: UBX
- **GPIO割り当て**: RX=GPIO16, TX=GPIO17
- **デバッグ出力**: 115200bps（シリアルモニター用）

### 表示仕様
- **画面解像度**: 320x240ピクセル
- **フォント**: 日本語フォント（efontJA_16）
- **更新頻度**: 3秒間隔
- **最大表示衛星数**: 20機
- **保存通報数**: 最大10件（FIFO方式）

### データ保存機能
- **保存形式**: メモリ内保存（電源OFFで消去）
- **保存内容**: 
  - 受信時刻
  - メッセージタイプ
  - 衛星ID
  - メッセージ長
  - Wordデータ（最大8 words）
- **管理方式**: FIFO（先入れ先出し）

## セットアップ手順

### 1. 必要なライブラリのインストール
Arduino IDEで以下のライブラリをインストールしてください：
- **SparkFun u-blox GNSS Arduino Library**
- **QZQSM** (QZSSメッセージ解析用)
- **QZSSDCX** (DCXメッセージ解析用)
- **M5Unified** (M5Stack用)

### 2. スケッチのアップロード
1. `qzss_disaster_receiver.ino`をArduino IDEで開く
2. ボード設定でM5Stack Coreを選択
3. シリアルポートを選択
4. スケッチをアップロード

### 3. 動作確認
1. シリアルモニターを開く（115200bps）
2. M5Stackの電源を入れる
3. 初期化メッセージが表示されることを確認
4. QZSS設定の成功メッセージを確認
5. 衛星情報の表示を確認

### 4. 災害通報受信テスト
1. 屋外でQZSS衛星を受信
2. L1S信号の受信を待機
3. 災害通報受信時の画面表示を確認
4. ボタンB、Cで保存機能をテスト

## 使用例

### 日常的な監視
- 24時間稼働でQZSS衛星の受信状況を監視
- 信号強度の変化を観察
- L1S信号の受信状況を確認

### 災害通報受信時
1. **リアルタイム受信**: 災害通報を受信すると即座に画面が切り替わる
2. **内容確認**: 日本語で解析された災害情報を確認
3. **履歴保存**: 通報は自動的に保存される
4. **詳細確認**: ボタンCで詳細情報を確認

### 過去の通報確認
1. **一覧表示**: ボタンBで保存された通報の一覧を表示
2. **詳細表示**: ボタンCで最新通報の詳細を確認
3. **分析**: 受信パターンや通報内容を分析

## ライセンス

このプロジェクトは元のコードベースに基づいており、適切なライセンスに従って使用してください。

### 謝辞
- [@ksasao氏](https://x.com/ksasao/status/1951457364667932775?s=06) - QZSS DC Report/DCX受信に関する貴重な情報の提供
- [スイッチサイエンス](https://www.switch-science.com/blogs/magazine/gps-qzss-dc-report-dcx-receiving) - 元のコードベースと技術資料の提供

## 参考資料

### 開発参考資料
- [@ksasao氏のQZSS DC Report/DCX受信記事](https://x.com/ksasao/status/1951457364667932775?s=06) - 本プロジェクトの開発動機となった記事
- [スイッチサイエンス - QZSS DC Report/DCX受信記事](https://www.switch-science.com/blogs/magazine/gps-qzss-dc-report-dcx-receiving) - 元のコードベースの記事
- [スイッチサイエンス - サンプルコード](https://github.com/SWITCHSCIENCE/samplecodes/tree/master/GPS_shield_for_ESPr/espr_dev_qzss_drc_drx_decode) - 元のコードベースのリポジトリ

### 機材・技術資料
- [M5Stack公式サイト](https://m5stack.com/)
- [スイッチサイエンス - M5Stack用GNSSモジュール](https://www.switch-science.com/catalog/7000/)
- [QZSS公式サイト](https://qzss.go.jp/)
- [u-blox公式サイト](https://www.u-blox.com/)
