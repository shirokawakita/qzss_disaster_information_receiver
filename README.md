# QZSS災害・危機管理通報受信システム

M5Stack Basicを使用してQZSS（準天頂衛星システム）からの災害・危機管理通報（DC Report/DCX）を受信・表示するシステムです。

## 概要

このシステムは、QZSS衛星からのL1S信号を受信し、災害情報をリアルタイムで表示します。災害通報が受信されていない間も、衛星の受信状況や信号強度を監視できます。

### 主な機能
- **リアルタイム衛星監視**: QZSS衛星の受信状況をリアルタイムで表示
- **信号強度表示**: 各衛星の信号強度を視覚的に表示
- **災害通報受信**: DC Report/DCXメッセージの自動受信・表示
- **多衛星システム対応**: GPS、Galileo、BeiDou、GLONASSも監視
- **日本語表示**: 日本語フォントによる分かりやすい表示

## 必要な機材

- **M5Stack Basic** (M5Stack Core)
- **M5Stack用GNSSモジュール 気圧/IMU/地磁気センサ付き（NEO-M9N/BMP280/BMI270/BMM150）** — スイッチサイエンス
- **GPSアンテナ** (U.FL/IPEXコネクタ対応)
- **USB Type-Cケーブル** (M5Stack用)

## 接続方法

### DIPスイッチ設定
画像に示されているDIPスイッチの設定：
- **TXスイッチ**: 1=ON, 2=ON, 3=OFF, 4=OFF
- **RXスイッチ**: 1=ON, 2=ON, 3=OFF, 4=OFF

この設定により、シリアル通信がGPIO16（RX）とGPIO17（TX）に割り当てられます。

### 物理接続
GNSSモジュールはM5Stackの内部に直接接続されており、追加の配線は不要です。

| 機能 | GPIO | 説明 |
|------|------|------|
| RX   | GPIO16 | 受信ピン |
| TX   | GPIO17 | 送信ピン |
| 電源 | 3.3V | 内部供給 |
| GND  | GND | 内部接続 |

### アンテナ接続
1. **アンテナの準備**: U.FL/IPEXコネクタ対応のGPSアンテナを用意
2. **コネクタ接続**: M5Stack基板上のU.FL/IPEXコネクタにアンテナを接続
3. **固定**: アンテナが外れないよう適切に固定

## M5Stackの操作方法

### 基本操作

#### **ボタンA（左ボタン）**
- **機能**: 画面の手動更新
- **使用場面**: 衛星情報の表示を最新状態に更新したい場合
- **操作方法**: ボタンを1回押す

#### **ボタンB（中央ボタン）**
- **機能**: 現在未使用
- **将来の拡張**: 設定メニューや表示モード切り替えに使用予定

#### **ボタンC（右ボタン）**
- **機能**: 現在未使用
- **将来の拡張**: 詳細情報表示やログ機能に使用予定

### 画面更新タイミング
- **自動更新**: 1秒間隔で衛星情報を自動更新
- **手動更新**: ボタンAを押すことで即座に画面更新
- **災害通報時**: 通報受信と同時に画面が切り替わる

### 画面表示の説明

#### **通常監視画面**
```
QZSS衛星情報監視中
==================
QZSS衛星: 3機受信中
------------------
QZSS-01: ||||| (25dB)
QZSS-02: |||| (20dB)
QZSS-03: ||| (15dB)
------------------
その他の衛星:
GPS: 8機
Galileo: 4機
BeiDou: 2機
------------------
更新: 12:34:56
```

#### **災害通報受信時**
- **DC Report受信**: 画面が赤色に変わり、災害情報を表示
- **DCX受信**: 画面がオレンジ色に変わり、拡張災害情報を表示

#### **エラー表示**
- **GNSSモジュール未検出**: 赤色画面でエラーメッセージ表示
- **衛星信号未受信**: 受信待機メッセージ表示
- **初期化中**: 起動時の初期化メッセージ表示

### 信号強度の見方

#### **バーグラフ表示**
- `|`: 信号強度の単位（5dBごと）
- 例: `|||||` = 25dB以上
- 例: `||` = 10-15dB

#### **信号強度の目安**
- **30dB以上**: 良好な受信状態
- **20-30dB**: 通常の受信状態
- **10-20dB**: 弱い信号（アンテナ調整推奨）
- **10dB未満**: 受信困難

### トラブルシューティング

#### **衛星が受信されない場合**
1. **アンテナの向きを確認**
   - 屋外で空が見える場所に移動
   - アンテナを水平に保つ
   - U.FL/IPEXコネクタが正しく接続されているか確認
2. **DIPスイッチ設定を確認**
   - TXスイッチ: 1=ON, 2=ON, 3=OFF, 4=OFF
   - RXスイッチ: 1=ON, 2=ON, 3=OFF, 4=OFF
   - 設定が正しくない場合は、ピンセットで調整
3. **初期化を待つ**
   - 初回起動時は衛星捕捉に数分かかる場合があります
4. **環境要因の確認**
   - 建物内や地下では受信が困難
   - 高層ビルや電波障害物の影響を確認

#### **画面が表示されない場合**
1. **電源を確認**
   - USBケーブルが正しく接続されているか確認
   - M5Stackの電源LEDが点灯しているか確認
2. **リセット**
   - M5Stackのリセットボタンを押す
   - 再起動後、初期化メッセージが表示されることを確認
3. **ファームウェア確認**
   - 正しいスケッチがアップロードされているか確認
   - Arduino IDEでシリアルモニターを開いてデバッグ情報を確認

## 技術仕様

### 使用機材詳細
- **GNSSモジュール**: u-blox NEO-M9N-00B-00
- **気圧センサ**: BMP280
- **IMUセンサ**: BMI270
- **地磁気センサ**: BMM150
- **アンテナコネクタ**: U.FL/IPEX

### 対応メッセージタイプ
- **MT 43**: DC Report（災害・危機管理通報）
- **MT 44**: DCX message（災害・危機管理通報拡張）
- **MT 47**: Monitoring Station Information
- **MT 48**: PRN Mask
- **MT 49**: Data Issue Number
- **MT 50**: DGPS Correction
- **MT 51**: Satellite Health
- **MT 63**: Null message

### 対応衛星システム
- **QZSS**: 準天頂衛星システム（メイン）
- **GPS**: 全地球測位システム
- **Galileo**: 欧州測位システム
- **BeiDou**: 中国測位システム
- **GLONASS**: ロシア測位システム

### 通信仕様
- **シリアル通信**: 9600bps（初期）、38400bps（自動切り替え）
- **通信プロトコル**: UBX
- **GPIO割り当て**: RX=GPIO16, TX=GPIO17
- **デバッグ出力**: 115200bps（シリアルモニター用）

### 表示仕様
- **画面解像度**: 320x240ピクセル
- **フォント**: 日本語フォント（efontJA_16）
- **更新頻度**: 1秒間隔
- **最大表示衛星数**: 8機（画面サイズに最適化）

## セットアップ手順

### 1. 必要なライブラリのインストール
Arduino IDEで以下のライブラリをインストールしてください：
- **SparkFun u-blox GNSS Arduino Library**
- **QZQSM** (QZSSメッセージ解析用)
- **M5Unified** (M5Stack用)

### 2. スケッチのアップロード
1. `qzss_disaster_receiver.ino`をArduino IDEで開く
2. ボード設定でM5Stack Coreを選択
3. シリアルポートを選択
4. スケッチをアップロード

### 3. 動作確認
1. シリアルモニターを開く（115200bps）
2. M5Stackの電源を入れる
3. 初期化メッセージが表示されることを確認
4. 衛星情報の表示を確認

## ライセンス

このプロジェクトは元のコードベースに基づいており、適切なライセンスに従って使用してください。

## 参考資料

- [QZSS DC Report/DCX受信記事](https://www.switch-science.com/blogs/magazine/gps-qzss-dc-report-dcx-receiving)
- [サンプルコード](https://github.com/SWITCHSCIENCE/samplecodes/tree/master/GPS_shield_for_ESPr/espr_dev_qzss_drc_drx_decode)
- [機材詳細](https://x.com/ksasao/status/1951457364667932775)
- [M5Stack公式サイト](https://m5stack.com/)
- [スイッチサイエンス - M5Stack用GNSSモジュール](https://www.switch-science.com/catalog/7000/)
